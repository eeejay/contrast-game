<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA! AAA!</title>
    <link rel="icon" type="image/x-icon" href="images/contrast-icon.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/matter-wrap@0.2.0/build/matter-wrap.min.js"></script>
    <script src="https://unpkg.com/color-name-list/dist/colornames.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');

        :root {
            --fail-color: #FF4C4C;
            --aa-color: #FFD700;
            --aaa-color: #32CD32;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            flex-direction: column;
            height: 100dvh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            justify-content: space-around;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: min(800px, 100vw);
            height: 75%;
            display: flex;
            /* height: 675px; */
        }

        #score {
            font-size: 50px;
            font-family: 'Bangers', cursive;
            /* Carnival-style font */
            color: #FF5733;
            text-shadow: 2px 2px #000;
            align-self: flex-start;
            margin-left: 1em;
        }

        #debug-info {
            display: none;
            position: absolute;
            top: 10px;
            right: -50px;
            font-size: 18px;
            font-family: 'Arial', sans-serif;
            color: #333;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
        }

        #game-over {
            display: none;
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-family: 'Bangers', cursive;
            color: #FF0000;
            text-shadow: 2px 2px #000;
            z-index: 1000;
        }

        #reset-btn {
            display: none;
            position: absolute;
            top: 75%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-family: 'Bangers', cursive;
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        #chosen-option {
            display: none;
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-family: 'Arial', sans-serif;
            color: #000;
            background-color: #fff;
            padding: 10px;
            border: 2px solid #000;
            border-radius: 5px;
            text-align: center;
        }

        .over #game-over,
        .over #reset-btn,
        .over #chosen-option {
            display: block;
        }

        @keyframes shimmer {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 10px rgba(255, 255, 255, 0.3), 0 0 15px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.9);
            }
        }

        #buttons {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 36px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease;
            font-family: 'Bangers', cursive;
            color: white;
            text-shadow: 1px 1px #000;
        }

        button:active {
            transform: scale(1.2);
        }

        button.shimmer {
            animation: shimmer 0.6s infinite;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #fail-btn {
            background-color: var(--fail-color);
            /* More vibrant red */
            box-shadow: 0 0 10px rgba(255, 76, 76, 0.5), 0 0 20px rgba(255, 76, 76, 0.5), 0 0 30px rgba(255, 76, 76, 0.5);
        }

        #aa-btn {
            background-color: var(--aa-color);
            /* More vibrant yellow */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.5);
        }

        #aaa-btn {
            background-color: var(--aaa-color);
            /* More vibrant green */
            box-shadow: 0 0 10px rgba(50, 205, 50, 0.5), 0 0 20px rgba(50, 205, 50, 0.5), 0 0 30px rgba(50, 205, 50, 0.5);
        }

        #sandbox {
            width: 100%;
            overflow: visible;
        }

        #sandbox>div {
            translate: -50% -50%;
            position: absolute;
        }


        #sandbox>.jar {
            transform-box: fill-box;
            opacity: 0;
        }

        foreignObject {
            overflow: visible;
        }

        .gumball {
            border-radius: 50%;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform-origin: center;
            position: relative;
            z-index: -3;
            background-color: var(--gumball-bg);
        }

        .gumball>div {
            text-align: center;
            width: 75%;
            padding: 0.5em 0;
            z-index: 0;
        }

        .gumball>div:first-child {
            border-bottom: solid 1px;
        }

        .current .gumball:before {
            content: "";
            position: absolute;
            border-radius: 50%;
            width: calc(100% + 15px);
            height: calc(100% + 15px);
            background: conic-gradient(#000 calc(var(--time-left)*1%), #0000 0);
            z-index: -2;
        }

        .current .gumball:after {
            content: "";
            position: absolute;
            border-radius: 50%;
            z-index: -1;
            width: 100%;
            height: 100%;
            background-color: var(--gumball-bg);
        }

        #stamps {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            pointer-events: none;
            z-index: 1000;
        }

        .stamp {
            position: absolute;
            top: 150px;
            left: 50%;
            z-index: 301;
            translate: -50% -50%;
            transition: opacity 1s, visibility 1s, scale 0s 1s;
            filter: drop-shadow(0 0 5px black);
            width: 220px;
            height: 220px;
            visibility: hidden;
            opacity: 0.0;
            scale: 2;
        }

        .stamp::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .stamp.show {
            visibility: visible;
            opacity: 1.0;
            scale: 1.0;
            transition: opacity 0.3s, visibility 0.3s, scale 0.1s;
        }

        #fail-stamp::before {
            background: url("images/fail.svg");
            mask: url('#fail-contrast-mask'), linear-gradient(#fff 0 0);
            mask-composite: exclude;
            mask-repeat: no-repeat;
        }

        #aa-stamp::before {
            background: url("images/aa.svg");
            mask: url('#aa-contrast-mask'), linear-gradient(#fff 0 0);
            mask-composite: exclude;
            mask-repeat: no-repeat;
        }

        #aaa-stamp::before {
            background: url("images/aaa.svg");
            mask: url('#aaa-contrast-mask'), linear-gradient(#fff 0 0);
            mask-composite: exclude;
            mask-repeat: no-repeat;
        }

        .gumball-jar {
            position: absolute;
            top: 0;
            width: 100%;
        }

        #screenreader-info {
            position: fixed;
            overflow: hidden;
            top: -101px;
            right: 0;
            height: 100px;
            width: 100px;
        }
    </style>
</head>

<body>
    <div id="screenreader-info">
        <div role="marquee" aria-live="assertive" id="current-ball-marquee"></div>
        <div aria-live="polite" role="timer" id="current-ball-timer">0</div>
    </div>
    <div id="score" role="status">Score: 0</div>
    <div id="stamps" role="presentation">
        <div role="image" id="fail-stamp" class="stamp"></div>
        <div role="image" id="aa-stamp" class="stamp"></div>
        <div role="image" id="aaa-stamp" class="stamp"></span></div>
        <svg style="display: block" aria-hidden="true" width="0" height="0" viewBox="0 0 0 0"
            xmlns="http://www.w3.org/2000/svg">
            <mask id="aa-contrast-mask">
                <text id="aa-contrast"
                    style="text-anchor: middle; font-style:normal;font-weight:bold;font-size:56px;font-family:'Droid Sans';fill:#ffffff"
                    x="110" y="132">cccc</text>
            </mask>
            <mask id="aaa-contrast-mask">
                <text id="aaa-contrast"
                    style="text-anchor: middle; font-style:normal;font-weight:bold;font-size:56px;font-family:'Droid Sans';fill:#ffffff"
                    x="110" y="132">cccc</text>
            </mask>
            <mask id="fail-contrast-mask">
                <text id="fail-contrast"
                    style="text-anchor: middle; font-style:normal;font-weight:bold;font-size:56px;font-family:'Droid Sans';fill:#ffffff"
                    x="110" y="130">cccc</text>
            </mask>
        </svg>
    </div>
    <div id="game-container" role="presentation">
        <svg role="list" id="sandbox" viewBox="0 0 500 675" xmlns="http://www.w3.org/2000/svg">
            <image role="presentation" x="0" y="0" width="500" height="675" href="images/jar-background.svg" />
            <g role="presentation" id="put-gumballs-here"></g>
            <image role="presentation" x="0" y="0" width="500" height="675" href="images/jar-outline.svg" />
            <image role="presentation" x="0" y="0" width="500" height="675" href="images/jar-foreground.svg" />
        </svg>
        <!-- <div id="sandbox">
            <div class="jar" id="jar-bottom"></div>
            <div class="jar side" id="jar-leftWall""></div>
            <div class="jar side" id="jar-rightWall""></div>
            <div class="jar" id="jar-bottomRightCorner">
            </div>
            <div class="jar" id="jar-bottomLeftCorner">
            </div>
            <?xml version="1.0" encoding="utf-8"?>ƒ
        </div> -->
        <div role="heading" aria-level="2" id="game-over">Game over!</div>
        <div id="chosen-option"></div>
        <button id="reset-btn">Restart</button>
        <div id="debug-info">Contrast Ratio: N/A</div>
    </div>
    <div id="buttons">
        <!-- TODO: make physical buttons do ALT + <accesskey> -->
        <button accesskey="a" id="fail-btn" data-rating="FAIL">Fail</button>
        <button accesskey="s" id="aa-btn" data-rating="AA">AA</button>
        <button accesskey="d" id="aaa-btn" data-rating="AAA">AAA</button>
    </div>

    <script type="module">
        import { QuizGenerator } from "./js/contrast-quiz.mjs";
        const quizGenerator = QuizGenerator();

        const btnFail = document.getElementById('fail-btn');
        const btnAA = document.getElementById('aa-btn');
        const btnAAA = document.getElementById('aaa-btn');
        const marquee = document.getElementById('current-ball-marquee');


        // Load the sounds and attempt to preload them so that they're ready
        // to go immediately. Sometimes Firefox lags a bit on playback but we
        // want it to ding or buzz right away.
        let buzzerWrong = new Audio("audio/buzzer-wrong.wav");
        let dingCorrect = new Audio("audio/ding-correct.wav");
        buzzerWrong.load();
        dingCorrect.load();

        let debugMode = location.hash.includes("debug");
        let cheatMode = location.hash.includes("cheat");
        const ballOverlap = 10;


        const { Engine, Render, World, Bodies, Body, Composite, Events, Runner } = Matter;

        const engine = Engine.create();
        const render = Render.create({
            // element: document.getElementById('game-container'),
            engine: engine,
            options: {
                width: 500, // Increased width
                height: 675, // Increased height
                wireframes: false,
                background: '#f0f0f0'
            }
        });

        // Create jar-like structure with flat bottom and curved corners
        const wallThickness = 20;
        const jarWidth = 400;
        const jarHeight = 500;
        const jarBottomThickness = 20;
        const cornerRadius = 30;

        const sandbox = document.getElementById("sandbox");
        function createBodyRect(id, x, y, width, height, angle = 0) {
            let elem = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            elem.id = id;
            elem.role = "presentation";
            elem.classList.add('jar');
            elem.setAttribute("x", x - width / 2);
            elem.setAttribute("y", y - height / 2);
            elem.setAttribute("width", width);
            elem.setAttribute("height", height);
            elem.classList.add("jar");
            sandbox.appendChild(elem);
            return Bodies.rectangle(x, y, width, height, {
                elem,
                width,
                height,
                isStatic: true,
                scaleFactor: 1,
                angle,
            });
        }

        const bottom = createBodyRect("jar-bottom", 250, 650, jarWidth, jarBottomThickness + ballOverlap);
        const leftWall = createBodyRect("jar-leftWall", 50, 400, wallThickness + ballOverlap, jarHeight);
        const rightWall = createBodyRect("jar-rightWall", 450, 400, wallThickness + ballOverlap, jarHeight);
        const bottomLeftCorner = createBodyRect("jar-bottomLeftCorner", 75, 649, 20, 75, -0.14);
        const bottomRightCorner = createBodyRect("jar-bottomRightCorner", 430, 615, 20, 75, 0.1);
        World.add(engine.world, [bottom, leftWall, rightWall, bottomLeftCorner, bottomRightCorner]);

        let counter = 0;

        (function rerender() {
            Engine.update(engine);
            if (debugMode && counter++ % 60 == 0) {
                for (let body of engine.world.bodies) {
                    console.log(body);
                }
            }
            for (let body of engine.world.bodies) {
                let elem = body.elem;
                if (!elem) {
                    continue;
                }
                let bounds = body.bounds;
                if (elem instanceof SVGRectElement) {
                    elem.setAttribute("x", bounds.min.x);
                    elem.setAttribute("y", bounds.min.y);
                    elem.setAttribute("width", body.width);
                    elem.setAttribute("height", body.height);
                    elem.setAttribute("transform", `rotate(${body.angle * 360})`);
                } else if (elem instanceof SVGForeignObjectElement) {
                    // Gumballs
                    elem.setAttribute("transform", `translate(${body.position.x}, ${body.position.y}) rotate(${body.angle * 360}) scale(${body.scaleFactor})`);
                }

            }

            requestAnimationFrame(rerender);
        })();

        let score = 0;
        let currentGumball = null;
        let first = true;
        function createGumball(x, y, quizCard, radius = 20) {
            let elem = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            elem.setAttribute("x", -radius);
            elem.setAttribute("y", -radius);
            elem.setAttribute("width", radius * 2);
            elem.setAttribute("height", radius * 2);
            elem.style.transform = `translate(${x}, ${y})`;
            elem.classList.add("current");

            let circle = document.createElement("div");
            circle.role = "listitem";
            circle.ariaLabel = `${quizCard.fgColorName} on ${quizCard.bgColorName}`;
            if (first) {
                setTimeout(() => {
                marquee.textContent = circle.ariaLabel;
            }, 1000);
            } else {
                marquee.textContent = circle.ariaLabel;
            }
            circle.classList.add("gumball");
            circle.style.setProperty('--gumball-bg', quizCard.cssBgColor);

            elem.appendChild(circle);

            let fg = document.createElement("div");
            fg.ariaHidden = "true";
            fg.textContent = quizCard.fgColorName;
            fg.style.color = quizCard.cssFgColor;
            circle.appendChild(fg);
            let bg = document.createElement("div");
            bg.ariaHidden = "true";
            bg.textContent = quizCard.bgColorName;
            bg.style.color = quizCard.cssFgColor;;
            circle.appendChild(bg);

            document.getElementById("put-gumballs-here").appendChild(elem);
            const gumball = Bodies.circle(x, y, radius - ballOverlap, {
                quizCard,
                elem,
                restitution: 0.5,
                friction: 0.005,
                scaleFactor: 1.0
            });

            return gumball;
        }

        function createNewGumball() {
            const quizCard = quizGenerator.next().value;
            currentGumball = createGumball(250, 50, quizCard, 80); // Lowered initial position and doubled size
            Body.setStatic(currentGumball, true);
            World.add(engine.world, currentGumball);
            resetTimer(); // Reset the timer for each new gumball
            if (debugMode) {
                document.getElementById('debug-info').textContent = `Contrast Ratio: ${currentGumball.quizCard.contrast.toFixed(2)}`;
            }
        }

        function slapStamp() {
            let contrastStamp = null;
            switch (currentGumball.quizCard.contrastRating) {
                case 'AAA':
                    contrastStamp = document.getElementById("aaa-stamp");
                    contrastStamp.ariaLabel = `AAA stamp: ${currentGumball.quizCard.contrast.toFixed(2)}`;
                    document.getElementById("aaa-contrast").textContent = currentGumball.quizCard.contrast.toFixed(2);
                    break;
                case 'AA':
                    contrastStamp = document.getElementById("aa-stamp");
                    contrastStamp.ariaLabel = `AA stamp: ${currentGumball.quizCard.contrast.toFixed(2)}`;
                    document.getElementById("aa-contrast").textContent = currentGumball.quizCard.contrast.toFixed(2);
                    break;
                case 'FAIL':
                    contrastStamp = document.getElementById("fail-stamp");
                    contrastStamp.ariaLabel = `FAIL stamp: ${currentGumball.quizCard.contrast.toFixed(2)}`;
                    document.getElementById("fail-contrast").textContent = currentGumball.quizCard.contrast.toFixed(2);
                    // contrastStamp.style.color = "var(--fail-color)";
                    break;
            }
            contrastStamp.style.rotate = `${Math.random() * 0.2 - 0.1}turn`;
            contrastStamp.classList.add("show");
        }

        function dropCurrentGumball() {
            dingCorrect.currentTime = 0;
            dingCorrect.play();
            slapStamp();
            if (currentGumball) {
                let scale = 1;
                const scaleStep = 2 / 15;
                currentGumball.elem.classList.remove("current");
                const interval = setInterval(() => {
                    scale -= scaleStep;
                    if (scale <= 0.15) {
                        scale = 0.15;
                        clearInterval(interval);
                        Body.setStatic(currentGumball, false);
                        Body.applyForce(currentGumball, { x: currentGumball.position.x, y: currentGumball.position.y }, { x: (Math.random() - 0.5) * 0.3, y: -.2 });
                        Body.setAngularVelocity(currentGumball, (Math.random() - 0.5) * 0.1); // Apply an angular speed for spinning
                        currentGumball = null;
                        score++;
                        document.getElementById('score').textContent = `Score: ${score}`;
                        setTimeout(createNewGumball, 1000); // Delay creation of next gumball
                    } else {
                        Body.scale(currentGumball, 1 - scaleStep, 1 - scaleStep);
                        currentGumball.scaleFactor *= 1 - scaleStep;
                    }
                }, 16); // Approx. 60fps
            }
        }

        function gameOver(userChoice) {
            document.body.classList.add("over");
            buzzerWrong.play();
            slapStamp();
            btnFail.disabled = true;
            btnAA.disabled = true;
            btnAAA.disabled = true;
            clearInterval(interval); // Stop the timer

            let contrastDesignation = currentGumball.quizCard.contrastRating;
            let actualContrast = currentGumball.quizCard.contrast.toFixed(2);

            document.getElementById('chosen-option').innerHTML = `You chose: ${userChoice}.<br>Actual contrast: ${actualContrast} (${contrastDesignation})`;
        }

        document.getElementById('reset-btn').addEventListener('click', () => {
            location.reload();
        });

        Events.on(render, 'afterRender', () => {
            const ctx = render.context;
            Composite.allBodies(engine.world).forEach(body => {
                renderGumballText(ctx, body);
            });
        });

        window.addEventListener('transitionend', evt => {
            if (!document.body.classList.contains("over") &&
                evt.target.classList.contains("stamp") &&
                evt.target.classList.contains("show") &&
                evt.propertyName != "scale") {
                evt.target.classList.remove("show")
            }
        });

        window.addEventListener("keydown", evt => {
            switch (evt.key) {
                case "1":
                    btnFail.click();
                    break;
                case "2":
                    btnAA.click();
                    break;
                case "3":
                    btnAAA.click();
                    break;
            }
        });

        document.getElementById('buttons').addEventListener('click', evt => {
            if (evt.target instanceof HTMLButtonElement && currentGumball) {
                if (evt.target.dataset.rating == currentGumball.quizCard.contrastRating || cheatMode) {
                    dropCurrentGumball();
                    resetTimer();
                } else {
                    gameOver(evt.target.dataset.rating);
                }
            }
        });

        let interval;

        function startTimer(duration) {
            clearInterval(interval);
            let timeLeft = duration;
            let timeLeftInSeconds = Math.ceil(timeLeft / 1000);
            document.documentElement.style.setProperty('--time-left', 100);
            interval = setInterval(() => {
                timeLeft -= 16;
                if (currentGumball) {
                    document.documentElement.style.setProperty('--time-left', (timeLeft / duration) * 100);
                    let newTimeInSeconds = Math.ceil(timeLeft / 1000);
                    if (newTimeInSeconds != timeLeftInSeconds) {
                        timeLeftInSeconds = newTimeInSeconds;
                        document.getElementById("current-ball-timer").textContent = `${timeLeftInSeconds} seconds left`;
                    }
                }
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    gameOver('Time Up');
                }
            }, 16);
        }

        function resetTimer() {
            startTimer(currentGumball.quizCard.timerDuration);
        }

        createNewGumball();
    </script>
</body>

</html>